import { Steps, Callout } from 'nextra/components'

# Firewall

Proxmox VE มีระบบ Firewall ที่ซับซ้อนและมีประสิทธิภาพสูง ซึ่งช่วยให้คุณสามารถกำหนดกฎความปลอดภัยได้ในหลายระดับ ได้แก่ **Datacenter**, **Node** และ **VM/LXC** การตั้งค่าผ่าน Web UI ทำให้ง่ายต่อการจัดการ

## หลักการสำคัญของ Proxmox Firewall

  * **ลำดับการทำงาน (Rule Evaluation Order):** กฎของ Firewall จะถูกประเมินจากระดับที่เฉพาะเจาะจงที่สุดไปหาระดับที่กว้างที่สุด:

    1.  **VM/LXC Level:** กฎที่กำหนดบน VM หรือ LXC นั้นๆ จะถูกประเมินก่อน
    2.  **Node Level:** หากไม่มีกฎที่ตรงกันบน VM/LXC หรือไม่ได้เปิดใช้งาน Firewall บน VM/LXC นั้นๆ จะไปประเมินกฎที่กำหนดบน Node นั้น
    3.  **Datacenter Level:** หากไม่มีกฎที่ตรงกันบน Node หรือไม่ได้เปิดใช้งาน Firewall บน Node นั้น จะไปประเมินกฎที่กำหนดบน Datacenter

  * **Default Policy:** โดยปกติแล้ว Proxmox Firewall จะเป็น "Default Deny" ซึ่งหมายความว่า หากไม่มีกฎที่อนุญาตการเชื่อมต่อใดๆ การเชื่อมต่อนั้นจะถูกบล็อก

  * **Activation:** คุณต้องเปิดใช้งาน Firewall ในแต่ละระดับ (Datacenter, Node, VM/LXC) ที่คุณต้องการให้ Firewall ทำงาน

## ขั้นตอนการตั้งค่า Firewall บน Proxmox (Web UI)

<Steps>

### เปิดใช้งาน Firewall

  * **ระดับ Datacente:**

    1.  เข้าสู่ Proxmox Web UI
    2.  คลิกที่ "Datacenter" ทางด้านซ้ายมือ
    3.  เลือกแท็บ "Firewall"
    4.  คลิกที่แท็บ "Options"
    5.  ค้นหา "Firewall" และเปลี่ยนค่าจาก "No" เป็น "Yes" (หากเป็น Cluster การตั้งค่านี้จะมีผลกับทุก Node)

  * **ระดับ Node:**

    1.  ใน Proxmox Web UI ให้คลิกที่ Node ที่ต้องการ (เช่น pve) ทางด้านซ้ายมือ
    2.  เลือกแท็บ "Firewall"
    3.  คลิกที่แท็บ "Options"
    4.  ค้นหา "Firewall" และเปลี่ยนค่าจาก "No" เป็น "Yes"

     *(You'll need to create this image or provide the correct path.)*

  * **ระดับ VM/LXC:**

    1.  ใน Proxmox Web UI ให้คลิกที่ VM หรือ LXC ที่คุณต้องการตั้งค่า
    2.  เลือกแท็บ "Firewall"
    3.  คลิกที่แท็บ "Options"
    4.  ค้นหา "Firewall" และเปลี่ยนค่าจาก "No" เป็น "Yes"
    5. นอกจากนี้ ให้แน่ใจว่าได้เปิดใช้งานตัวเลือก Firewall สำหรับ Network Device (NIC) แต่ละตัวของ VM/LXC ของคุณด้วย โดยไปที่ VM/LXC -> Hardware -> Network Device -> Edit -> Firewall (ทำเครื่องหมายถูกที่ช่อง)

     *(You'll need to create this image or provide the correct path.)*
     *(You'll need to create this image or provide the correct path.)*

### Add Firewall Rules

Once the firewall is enabled at the desired levels, you can start adding rules to allow or deny traffic.

  * **To add a rule at the Datacenter Level:**

    1.  Go to "**Datacenter**" -\> "**Firewall**" -\> "**Rules**" tab.
    2.  Click "**Add**".
    3.  Configure the rule:
          * **Action:** Choose "**ACCEPT**" (to allow traffic) or "**DROP**" (to block traffic silently) or "**REJECT**" (to block traffic and send a "connection refused" message).
          * **Direction:** "**IN**" for incoming traffic, "**OUT**" for outgoing traffic.
          * **Enable:** Check this box to activate the rule.
          * **Comment:** (Optional) Add a descriptive comment.
          * **Source:** (Optional) IP address or CIDR range of the source.
          * **Dest:** (Optional) IP address or CIDR range of the destination.
          * **Protocol:** (Optional) e.g., `tcp`, `udp`, `icmp`.
          * **Port:** (Optional) Specific port number or range (e.g., `80`, `22`, `1024:2048`).
    4.  Click "**Add**".

    \<Callout type="info" title="Rule Order Matters"\>
    Rules are processed from top to bottom. If you have an "ACCEPT" rule for a specific port and a "DROP" rule below it for the same port but broader scope, the "ACCEPT" rule might take precedence for matching traffic. Use the up/down arrows to reorder rules if needed.
    \</Callout\>

     *(You'll need to create this image or provide the correct path.)*

  * **To add a rule at the Node Level:**

    1.  Go to the specific **Node** (e.g., `pve`) -\> "**Firewall**" -\> "**Rules**" tab.
    2.  Follow the same steps as adding a rule at the Datacenter level.

     *(You'll need to create this image or provide the correct path.)*

  * **To add a rule at the VM/LXC Level:**

    1.  Go to the specific **VM** or **LXC** -\> "**Firewall**" -\> "**Rules**" tab.
    2.  Follow the same steps as adding a rule at the Datacenter level.

     *(You'll need to create this image or provide the correct path.)*

### Use IP Sets (Optional, but Recommended for Complex Setups)

IP Sets allow you to group multiple IP addresses or CIDR ranges together and use them in your firewall rules. This simplifies management and makes your rules more readable.

  * **To create an IP Set:**

    1.  Go to "**Datacenter**" -\> "**Firewall**" -\> "**IP Sets**" tab.
    2.  Click "**Create**".
    3.  Give it an **ID** (e.g., `allowed_ssh_ips`).
    4.  Add **Comment** (optional).
    5.  Click "**Create**".
    6.  To add IPs, select the created IP Set and click "**Add**". Enter the IP address or CIDR range.

     *(You'll need to create this image or provide the correct path.)*
     *(You'll need to create this image or provide the correct path.)*

  * **To use an IP Set in a rule:**

    When adding or editing a firewall rule, in the **Source** or **Dest** field, instead of a direct IP, use `@your_ip_set_id` (e.g., `@allowed_ssh_ips`).

     *(You'll need to create this image or provide the correct path.)*

</Steps>